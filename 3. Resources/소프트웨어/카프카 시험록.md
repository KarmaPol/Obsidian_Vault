1. ec2에 카프카 서버 배포
   - docker swarm에 카프카 서버 노드 추가
```bash
# 매니저 노드
docker swarm join-token worker
```

```bash
# 워커 노드
docker swarm join --token <스웜 토큰> 43.202.238.236:2377 --advertise-addr 3.34.180.0
```
   - 서버 라벨 등록
```bash
docker node update --label-add kafka_server=true swarm-worker1
```
- docker-swarm 스택 배포
```yml
version: '3'

services:
    deploy:
    ports:
      - "2181:2181"
  kafka:
    restart: always
    image: wurstmeister/kafka:2.12-2.5.0
    container_name: kafka
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.kafka_server == true # 라벨로 노드 제한
    ports:
      - "9092:9092"
    environment:
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:19092,EXTERNAL://3.34.180.0:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_LISTENERS: INTERNAL://0.0.0.0:19092,EXTERNAL://0.0.0.0:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_ADVERTISED_HOST_NAME: 3.34.180.0 # 외부 서버 ip 주소
      KAFKA_ADVERTISED_PORT: 9092
      KAFKA_CREATE_TOPICS: "coupon_create:1:1"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
```

```bash
docker stack deploy -c db-compose.yml kafka
```

2. 스프링 부트 어플리케이션 연동
```java
@Configuration  
public class KafkaConsumerConfig {  
  
	@Bean  
	public ConsumerFactory<String, Long> consumerFactory(){  
		Map<String, Object> config = new HashMap<>();  
		  
		config.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG,
		 "3.34.180.0:9092");  
		config.put(ConsumerConfig.GROUP_ID_CONFIG, "group_1");  
		config.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG,
		 StringDeserializer.class);  
		config.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, 
		LongDeserializer.class);  
		  
		return new DefaultKafkaConsumerFactory<>(config);  
	}  
	  
	@Bean  
	public ConcurrentKafkaListenerContainerFactory<String, Long> 
	kafkaListenerContainerFactory(){  
		ConcurrentKafkaListenerContainerFactory<String, Long> factory = 
		new ConcurrentKafkaListenerContainerFactory<>();  
		factory.setConsumerFactory(consumerFactory());  
	  
		return factory;  
	}  
}
```

3. 스프링 부트 어플리케이션 배포
- 도커 파일 작성
```DockerFile
# Build stage  
FROM gradle:8.2.1-jdk17 AS builder  
WORKDIR /workspace  
  
# Copy all necessary files  
COPY . .  
  
# Build the project  
RUN gradle build -x test  
  
# Runtime stage  
FROM openjdk:17-jdk-slim  
WORKDIR /app  
  
ARG JAR_PATH=/workspace/build/libs  
ARG JAR_FILE_NAME=api-0.0.1-SNAPSHOT.jar  
  
COPY --from=builder ${JAR_PATH}/${JAR_FILE_NAME} app.jar  
ENTRYPOINT ["sh", "-c", "java ${JAVA_OPTS} -jar /app/app.jar"]
```
- 도커 이미지 빌드 & 업로드
```bash
docker build --platform linux/amd64 -t karmapol/kafka-test:0.1 .
docker push karmapol/kafka-test:0.1
```
4. api, consumer 배포
![[Pasted image 20231229222535.png]]

![[Pasted image 20231229222653.png]]
- 싱글 브로커 카프카 1대
- api 서버 컨테이너 4대
- 컨슈머 서버 컨테이너 4대

- 그 이상 구축하면 에러 발생
```
java.sql.SQLNonTransientConnectionException: Too many connections
```
5. Ngrinder 구축 
