## 지난 미션 리뷰
### AnonymousAuthenticationFilter
- 해당 필터에 도달할때까지 사용자가 인증되지 않았다면, 사용자를 null 대신 Anonymous 인증 타입으로 표현
- getContext().getAuthentication() == null이면,  
  AnonyMousAuthenticationToken(this.key, this.principle, this.authorities) 생성하여 사용자에 주입
### AccessDeniedHandler
accessDeniedHandler를 생성해 필터 체인에 등록하면, 권한 오류 시 어떻게 처리해줄 지 커스텀 가능
## Security Essentials
### Thread Per Request 모델과 ThreadLocal
#### Thread Per Request
[![Spring Boot가 다중요청을 처리하는 방법](https://blog.kakaocdn.net/dn/lINnh/btssaaP8ZMj/kR9NvUXQp54qhNMZXsQ9C0/img.png)

- WAS는 ThreadPool 생성 (톰캣 기본값 200)
- HTTP 요청은 들어오면 Queue에 적재, 쓰레드 풀의 쓰레드가 큐에서 요청 가져와 처리
- 요청은 쓰레드에서 처리되고, 끝나면 다시 쓰레드풀에 반납
- 즉, WAS의 최대 동시 처리 HTTP 요청 갯수는 ThreadPool 갯수와 같음
- Thread 갯수를 늘리면 동시 처리 갯수가 늘어나지만, 
  Thread Context 스위칭에 의한 오버헤드도 커지므로 선형적 성능 증가 X
#### ThreadLocal
Thread 로컬 범위 변수 - 동일 쓰레드 내에서 접근할 수 있는 변수
```java
final static ThreadLocal<Integer> threadLocalValue = new ThreadLocal<>();

public static void main(String[] args){
	threadLocalValue.set(1);
	a(); // value = 1
	b(); // value = 1

	CompletableFuture<Void> task = runAsync(() -> {
		a();
		b();
	});

	task.join(); // value = null - 다른 쓰레드에서는 main 쓰레드의 값에 접근할 수 없다
}

public static void a() {
	Integer value = threadLocalValue.get();
}

public static void b() {
	Integer value = threadLocalValue.get();
}

```
- 동일 쓰레드 내에서 실행되는 Controller, Service, Repository.. 어디서든 ThreadLocal 변수에 접근 가능
  -> ThreadPool에 반환되기 직전 ThreadLocal 변수 값을 제거해야함
  -> 제거하지 않을 경우, 이전 요청 처리에 사용된 ThreadLocal 변수가 남아있어 잘못된 동작 수행 가능
