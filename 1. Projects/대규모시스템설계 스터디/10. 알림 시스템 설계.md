# 알림 시스템
- 모바일 푸쉬 알림
- SMS 메시지
- 이메일
## 1단계. 문제 이해 및 설계 범위 확정
- 푸쉬 알림, SMS, 이메일 지원
- soft real-time 시스템
- ios, 안드로이드, 데스크톱 지원
- 알림은 서버, 클라이언트 측에서 제공
- 사용자 설정으로 알림 끄기 가능
- 천만 건의 모바일 푸쉬 알림, 백만 건의 SMS 메시지, 5백만 건의 이메일
## 2단계. 개략적 설계안 제시 및 동의 구하기
### 알림 유형별 지원 방안
#### iOS 푸시 알림
3가지 컴포넌트
- 알림 제공자
  알림 요청을 만들어 Apple Push Notification Service로 보내는 주체
	- 단말 토큰
	  알림 요청 고유 식별자
	- 페이로드
	  알림 내용을 담은 JSON 딕셔너리
- APNS
  애플 제공 푸시 알림 원격 서비스
- iOS 단말
  푸시 알림 수신 사용자 단말
### 안드로이드 푸시 알림
iOS와 유사하나 APNS 대신 FCM을 사용
### SMS 메시지
트윌리오, 넥스모 등 제 3 사업자 서비스 사용
### 이메일
주로 센드그리드, 메일침프 등 사용 이메일 서비스 이용
## 연락처 정보 수집 절차
알림을 보내려면 모바일 단말 토큰, 전화번호, 이메일 주소 등의 정보 필요
보통 User-Device 일대다 관계로 DB에서 표현
### 알림 전송 및 수신 절차
#### 초안
서비스 - 알림 시스템(서버 1대) - 제 3자 서비스 - 클라이언트 로 구성
##### 구성 요소
- 서비스
  서비스 각각은 마이크로 서비스 혹은 크론잡, 분산 시스템 컴포넌트일 수 있음
  과금 서비스, 배송 알림 서비스 등
- 알림 시스템
  서비스 각각에 알림 전송을 위한 API를 제공, 제 3자 서비스에 전달할 알림 페이로드 생성
- 제 3자 서비스
  사용자에게 알림을 실제로 전달
  이때 제 3자 서비스의 도입은 확장성을 고려해 쉽게 다른 서비스로 대체 가능해야함
##### 문제점
- SPOF
  알림 시스템 서버가 하나일때, 해당 서버 장애시 전체 시스템 장애
- 규모 확장성
  서버 한대로 처리하므로 DB나 캐시 등 중요 컴포넌트 규모를 개별적으로 늘릴 수 없음
- 성능 병목
  알림을 처리하고 보내는 과정에서 사용자 트래픽이 몰리는 시간에 시스템 과부화 발생 가능
#### 개선안
서비스 - 알림 서버=캐시=DB - 메시지 큐 - 작업 서버 - 제 3자 서비스 - 클라이언트 로 구성
- DB와 캐시를 알림 시스템 주 서버에서 분리
- 알림 서버를 증설하고 자동으로 스케일 아웃할 수 있도록 함
- 메시지 큐로 컴포넌트 간 강한 결합을 분리
  제 3자 서비스 중 하나에서 장애 발생해도 다른 알림은 정상 동작
## 3단계. 상세 설계
### 안정성
분산 환경 알림 시스템 설계시 안정성을 위한 사항들을 고려해야함
#### 데이터 손실 방지
지연, 순서가 보장되지 않더라도 어떤 상황에서도 알림이 소실되면 안된다
알림 로그 DB를 유지하면서 재시도 메커니즘을 구현해야함
### 알림 중복 전송 방지
분산 시스템 특성 상 가끔씩 중복 알림이 전송될 수 있음
빈도수를 줄이기 위해 이벤트 ID를 검사한 뒤 보내는 식으로 처리 가능
### 추가 컴포넌트 및 고려사항
#### 알림 템플릿
알림 메시지 대부분은 형식이 비슷함 -> 알림 템플릿 도입
parameter, 스타일, tracking link만 조정하면 됨
#### 알림 설정
사용자의 알림 수신 여부를 DB에 저장
channel(varchar), opt_in(boolean)과 같은 필드를 알림 설정 테이블에 보관
#### 전송률 제한
한 사용자에게 너무 많은 알림이 가면 알림 자체를 꺼버릴 수 있기 때문에,
알림의 빈도를 제한
#### 재시도 방법
제 3자 서비스의 알림 전송 실패 시, 재시도 전용 큐에 넣는다
같은 문제가 계속 발생 시 개발자에게 통지
#### 푸시 알림과 보안
iOS, 안드로이드의 경우 verified된 클라이언트만 API로 알림을 보낼 수 있음
#### 큐 모니터링
큐에 쌓인 알림의 개수를 모니터링할 수 있음
이 수가 너무 크면, 작업 서버가 빠르게 처리하고 있지 못하다는 뜻
=> 작업 서버 증설 필요
#### 이벤트 추적
analytics로 사용자의 이벤트를 추적 가능

