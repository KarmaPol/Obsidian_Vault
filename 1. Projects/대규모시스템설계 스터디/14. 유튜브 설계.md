## 문제 이해 및 설계 범위 확정
- 빠른 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택
- 낮은 인프라 비용
- 높은 가용성과 규모 확장성, 안정성
- 모바일, 웹, TV 지원

- 매일 저장되는 용량 150TB
- 모든 비디오 기준 매일 발생하는 CDN 비용 5백만 * 5비디오 * 0.3GB * 0.02 = 150000달러
  -> 비용 최적화 필요
## 개략적 설계안
### 비디오 업로드 절차
1. 비디오를 원본 저장소에 업로드
2. 트랜스 코딩 서버는 원본 저장소에서 비디오 가져와 작업 시작
3. 트랜스 코딩 완료시 다음 작업 병렬 수행
   a. 완료 비디오를 트랜스코딩 비디오 저장소에 업로드
   b. 완료 이벤트를 트랜스코딩 완료 큐에 넣는다 
   -> 트랜스코딩 완료 핸들러가 메타데이터 DB와 캐시 갱신
4. API 서버가 단말에게 스트리밍 준비가 되었음을 알림
### 비디오 스트리밍 절차
애플 HLS, 마이크로소프트 스무드 스트리밍 등 다양한 스트리밍 프로토콜
비디오는 가장 가까운 CDN 서버에서 스트리밍
## 상세 설계
### 비디오 트랜스코딩
#### 필요성
- 원본 비디오는 저장 공간을 많이 차지함
- 호환성을 위해 하나의 비디오를 여러 포맷으로 인코딩하는 것이 바람직
- 네트워크 대역폭이 충분하지 않은 사용자에겐 저화질, 아닌 사용자는 고화질 비디오
- 모바일 단말의 경우, 네트워크 상황이 안 좋아지면 자동으로 화질 변경
#### 인코딩 포맷
- 컨테이너 
  비디오 파일, 오디오, 메타데이터를 담는 바구니
  .avi, .mp4
- codec
  비디오 화질은 보존하면서 파일 크기를 줄이는 압축 및 압축 해제 알고리즘
### 유향 비순환 그래프(DAG) 모델 
비디오 프로세싱 작업을 순차적 및 병렬적으로 실행될 수 있게 한다
- 비디오
  - 검사
  - 인코딩
  - 섬네일 추출
  - 워터마크
- 오디오
- 메타데이터
### 비디오 트랜스코딩 아키텍처
전처리기 -> DAG 스케줄러 -> 자원 관리자 -> 작업 실행 서버 -> 인코딩된 비디오
#### 전처리기
- 비디오 스트림을 GOP 단위로 쪼갬, 독립적으로 재생 가능하며 몇 초 정도
  보통 클라이언트 측에서 GOP 단위로 쪼개서 업로드함
- DAG 생성
  설정 파일에 따라 DAG 생성
- 데이터 캐시
  GOP와 메타데이터를 임시 저장소에 보관 -> 인코딩 실패시 보관 데이터 활용
#### DAG 스케줄러
DAG 그래프를 단계별로 분할해(비디오 추출, 오디오 추출, 비디오 인코딩, 섬네일..) 
작업 큐에 넣는다
#### 자원 관리자
세 개의 큐와 작업 스케줄러로 구성
- 작업 큐
  작업 보관하는 우선순위 큐
- 작업 서버 큐
  작업 서버 가용 상태 저장 보관
- 실행 큐
  실행 중인 작업 및 작업 서버 정보 보관
- 작업 스케줄러
  최적의 작업/서버 조합 선택하여 수행 지시
#### 작업 서버
DAG 정의된 작업 수행, 작업 종류에 따라 작업 서버도 구분(워터마크, 인코딩, 섬네일..)
#### 임시 저장소
메타 데이터는 작업서버가 빈번히 참조하고, 크기가 작으므로 메모리 캐시
비디오/오디오 데이터는 BLOB 저장소가 적절
비디오 프로세싱 완료 시 임시 저장소 데이터 삭제
### 시스템 최적화
#### 속도 최적화 : 비디오 병렬 업로드
클라이언트 측에서 원본 저장소에 GOP 단위로 병렬 업로드
#### 속도 최적화 : 업로드 센터를 사용자 근거리에 지정
#### 속도 최적화 : 모든 절차를 병렬화
각 모듈이 이전 모듈의 작업이 끝날 때까지 기다려야 했다
-> 메시지 큐 도입
-> 시스템의 결합도를 낮추어 병렬성을 높인다
#### 안전성 최적화 : 미리 사인된 업로드 URL
허가받은 사용자만 올바른 장소에 비디오를 업로드 할 수 있도록,
URL을 미리 할당해서 영상을 업로드한다 -> API 서버는 미리 사인된 URL을 요청 시 바로 돌려준다
#### 안전성 최적화 : 비디오 보호
- DRM (디지털 저작권 관리)
- AES 암호화
- 워터마크
#### 비용 최적화
1. 인기 비디오는 CDN, 나머지 비디오는 비디오 서버를 이용
2. 인기가 없고 짧은 비디오는 필요할 때 인코딩
3. 특정 지역에서만 인기가 높은 비디오는 다른 지역 CDN에 옮기지 않는다
4. CDN을 직접 구축
### 오류 처리
1. 회복 가능 오류
   트랜스 코딩 오류 등 재시도하면 해결되는 오류
2. 회복 불가능 오류
   비디오 포맷이 잘못되었거나 회복 불가능한 오류 발견시 작업 중단 후 오류 코드 반환
#### 전형적 해결 방법
- 업로드 오류 
  재시도