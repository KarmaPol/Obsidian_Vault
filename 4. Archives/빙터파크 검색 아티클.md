![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/a557051f-c7ef-49b4-83dc-fbd1373d5693/6369ae19-32a7-4332-bb13-f5006b5fb1bd/Untitled.png)

ì´ë²ˆ í”„ë¡œê·¸ë˜ë¨¸ìŠ¤ ë°ë¸Œì½”ìŠ¤ 2ì°¨ íŒ€ í”„ë¡œì íŠ¸ë¡œ â€œì¸í„°íŒŒí¬ í‹°ì¼“â€ì˜ í´ë¡  ì½”ë”©ì„ ì§„í–‰í•˜ì˜€ìŠµë‹ˆë‹¤.

ê²€ìƒ‰ ê¸°ëŠ¥ì„ ì—˜ë¼ìŠ¤í‹± ì„œì¹˜ë¥¼ í†µí•´ êµ¬í˜„í•˜ê³ , RDBë§Œì„ ì‚¬ìš©í–ˆì„ ë•Œ ë³´ë‹¤ ì„±ëŠ¥ì„ ê°œì„ í•œ ì‚¬ë¡€ë¥¼ ê³µìœ í•˜ê² ìŠµë‹ˆë‹¤.

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/a557051f-c7ef-49b4-83dc-fbd1373d5693/02eb118d-660c-4e91-8653-2cbac94f2d96/Untitled.png)

ë¨¼ì € ì €í¬ëŠ” â€œì¸í„°íŒŒí¬ í‹°ì¼“â€ ê²€ìƒ‰ ê¸°ëŠ¥ì„ ë¶„ì„í•˜ì˜€ìŠµë‹ˆë‹¤.

- í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•˜ë©´ ê³µì—°ì˜ ì œëª© ë¿ë§Œ ì•„ë‹ˆë¼ ë‚´ìš©, ì¥ë¥´ê¹Œì§€ í•¨ê»˜ ê²€ìƒ‰ë©ë‹ˆë‹¤.
- ë¶€ê°€ì ìœ¼ë¡œ ìœ ì‚¬ì–´ë‚˜ ì´ˆì„±ìœ¼ë¡œë„ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ì§€ì—°ì‹œê°„ì€ 300ms ì´ë‚´ ì˜€ìŠµë‹ˆë‹¤.

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/a557051f-c7ef-49b4-83dc-fbd1373d5693/3ea61fc9-95d0-4452-8c3a-716ad6f0216b/Untitled.png)

ê¸°ëŠ¥ì ìœ¼ë¡œ, ì„±ëŠ¥ì ìœ¼ë¡œë„ RDBì™€ JPAì„ ì‚¬ìš©í•˜ì—¬ ê²€ìƒ‰ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê¸°ê°€ ê¹Œë‹¤ë¡œì› ìŠµë‹ˆë‹¤.

íŠ¹íˆ ìœ ì‚¬ì–´, ì´ˆì„± ê²€ìƒ‰ì€ JPAë§Œìœ¼ë¡œ êµ¬í˜„í•˜ê¸° ë§¤ìš° ì–´ë µê³ , likeë¬¸ìœ¼ë¡œ êµ¬í˜„í•  ê²½ìš°, ê·¸ íŠ¹ì„± ìƒ ëª¨ë“  ë ˆì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ë°ì´í„°ê°€ ë§ë‹¤ë©´ ì„±ëŠ¥ì„ ë³´ì¥í•˜ê¸° ì–´ë ¤ì› ìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ ì €í¬ëŠ” ì´ëŸ¬í•œ ìš”êµ¬ì‚¬í•­ë“¤ì„ ì¶©ì¡±í•˜ê³ ì ì—˜ë¼ìŠ¤í‹± ì„œì¹˜ë¥¼ ë„ì…í•˜ì˜€ìŠµë‹ˆë‹¤.

## ì—˜ë¼ìŠ¤í‹± ì„œì¹˜ê°€ ì™œ ë” ë¹ ë¥¼ê¹Œ?

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/a557051f-c7ef-49b4-83dc-fbd1373d5693/dae0d8e6-49a0-41e4-8e88-d6f6df4244ce/Untitled.png)

ì „í†µì ì¸ RDB ì—ì„œÂ **like**Â ê²€ìƒ‰ì„ ì‚¬ìš©í•˜ë©´ ë°ì´í„°ê°€ ëŠ˜ì–´ë‚ ìˆ˜ë¡ ê²€ìƒ‰í•´ì•¼ í•  ëŒ€ìƒì´ ëŠ˜ì–´ë‚˜ ì‹œê°„ë„ ì˜¤ë˜ ê±¸ë¦¬ê³ , row ì•ˆì˜ ë‚´ìš©ì„ ëª¨ë‘ ì½ì–´ì•¼ í•˜ê¸° ë•Œë¬¸ì— ê¸°ë³¸ì ìœ¼ë¡œ ì†ë„ê°€ ëŠë¦½ë‹ˆë‹¤.

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/a557051f-c7ef-49b4-83dc-fbd1373d5693/30b48ec7-69f1-4183-a1a5-39b40a8cd509/Untitled.png)

í•˜ì§€ë§Œ ì—˜ë¼ìŠ¤í‹± ì„œì¹˜ëŠ” ì—­ ì¸ë±ìŠ¤(inverted index) êµ¬ì¡°ë¡œ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê¸° ë•Œë¬¸ì— íŠ¹ì • ë‹¨ì–´ê°€ ì–´ë–¤ ì¸ë±ìŠ¤(ë¬¸ì„œ)ì— ì €ì¥ë˜ì—ˆëŠ”ì§€ ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

_ì¶œì²˜ :Â [ì—˜ë¼ìŠ¤í‹± ì„œì¹˜ ê°€ì´ë“œë¶](https://esbook.kimjmin.net/06-text-analysis/6.1-indexing-data)_

### JPA

- ì½”ë“œ ğŸ’»
    
    ```java
    @Override
    	public Page<EventResponse> getEventsByKeyword(EventKeywordSearchDto eventKeywordSearchDto) {
    		Pageable pageable = eventKeywordSearchDto.pageable();
    		int offset = pageable.getPageNumber() * pageable.getPageSize();
    
    		List<EventResponse> content = jpaQueryFactory.selectFrom(event)
    				.where(
    					containsKeyword(eventKeywordSearchDto.keyword()), // í‚¤ì›Œë“œ ê²€ì‚¬
    					isGenreType(eventKeywordSearchDto.genreType()) // ì¥ë¥´ í•„í„°
    				)
    				.offset(offset)
    				.limit(pageable.getPageSize())
    				.fetch()
    				.stream()
    				.map(EventResponse::of)
    				.toList();
    
    		JPAQuery<Long> countQuery = jpaQueryFactory.select(event.count())
    				.from(event)
    				.where(
    					containsKeyword(eventKeywordSearchDto.keyword()),
    					isGenreType(eventKeywordSearchDto.genreType())
    				);
    
    		return PageableExecutionUtils.getPage(content, pageable, countQuery::fetchOne);
    	}
    
    private BooleanBuilder containsKeyword(String keyword){
    		BooleanBuilder booleanBuilder = new BooleanBuilder();
    		if(keyword == null) {
    			return null;
    		}
    		booleanBuilder.or(event.title.contains(keyword));
    		booleanBuilder.or(event.description.contains(keyword));
    
    		return booleanBuilder;
    	}
    
    // ìƒëµ
    ```
    

ë¨¼ì € JPA, queryDslì™€ likeë¬¸ìœ¼ë¡œ ì œëª©, ì¥ë¥´ì—ì„œ í‚¤ì›Œë“œë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆëŠ” ê¸°ë³¸ì ì¸ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.

### ì—˜ë¼ìŠ¤í‹± ì„œì¹˜ (Spring Data ElasticSearch)

- ì½”ë“œ ğŸ’»
    
    ```java
    public Page<EventDocumentResponse> findByKeyword(EventKeywordSearchDto eventKeywordSearchDto) {
    		Pageable pageable = eventKeywordSearchDto.pageable();
    		NativeQuery query = getKeywordSearchNativeQuery(eventKeywordSearchDto).setPageable(pageable);
    
    		SearchHits<EventDocument> searchHits = elasticsearchOperations.search(query, EventDocument.class);
    		log.info("event-keyword-search, {}", eventKeywordSearchDto.keyword());
    
    		return SearchHitSupport.searchPageFor(searchHits, query.getPageable()).map(s -> {
    			EventDocument eventDocument = s.getContent();
    			return EventDocumentResponse.of(eventDocument);
    		});
    	}
    
    private NativeQuery getKeywordSearchNativeQuery(EventKeywordSearchDto eventKeywordSearchDto) {
    		NativeQueryBuilder queryBuilder = new NativeQueryBuilder();
    
    		Query query = QueryBuilders.match()
    			.query(eventKeywordSearchDto.keyword())
    			.field("keyword_text")
    			.build()._toQuery();
    
    		List<Query> filterList = new ArrayList<>();
    
    		if (eventKeywordSearchDto.genreType() != null) {
    			List<FieldValue> fieldValues = eventKeywordSearchDto.genreType().stream()
    				.map(FieldValue::of)
    				.toList();
    
    			TermsQueryField termsQueryField = new TermsQueryField.Builder()
    				.value(fieldValues)
    				.build();
    
    			Query genreFilterQuery = QueryBuilders
    				.terms()
    				.field("genreType")
    				.terms(termsQueryField)
    				.build()._toQuery();
    
    			filterList.add(genreFilterQuery);
    		}
    
    		if (eventKeywordSearchDto.startedAt() != null) {
    			Query startedAtFilterQuery = QueryBuilders
    				.range()
    				.field("startedAt")
    				.gte(JsonData.of(eventKeywordSearchDto.startedAt()))
    				.build()._toQuery();
    
    			filterList.add(startedAtFilterQuery);
    		}
    
    		if (eventKeywordSearchDto.endedAt() != null) {
    			Query endedAtFilterQuery = QueryBuilders
    				.range()
    				.field("endedAt")
    				.gte(JsonData.of(eventKeywordSearchDto.endedAt()))
    				.build()._toQuery();
    
    			filterList.add(endedAtFilterQuery);
    		}
    
    		Query boolQuery = QueryBuilders.bool()
    			.filter(filterList)
    			.must(query)
    			.build()._toQuery();
    		
    		return queryBuilder.withQuery(boolQuery)
    			.build();
    	}
    ```
    

ì—˜ë¼ìŠ¤í‹± ì„œì¹˜ë„ ë§ˆì°¬ê°€ì§€ë¡œ ì œëª©, ì¥ë¥´, ì„¤ëª…ì—ì„œ í‚¤ì›Œë“œë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆëŠ” ì¿¼ë¦¬ë¥¼ ì‘ì„±í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.

ì´ë•Œ ìŒì ˆ ë‹¨ìœ„ì˜ ê²€ìƒ‰ì„ ìœ„í•´Â [ngram ë¶„ì„ê¸°ë¥¼ ì ìš©í•˜ê³ , ì´ˆì„±ê²€ìƒ‰ì„ ìœ„í•´ ì¶”ê°€ í”ŒëŸ¬ê·¸ì¸](https://github.com/Team-BingBong/BE-05-Bingterpark/wiki/%EC%97%98%EB%9D%BC%EC%8A%A4%ED%8B%B1-%EC%84%9C%EC%B9%98-%ED%82%A4%EC%9B%8C%EB%93%9C-%EA%B2%80%EC%83%89)ì„ ì ìš©í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.

## íŠ¸ëŸ¬ë¸” ìŠˆíŒ…

### ì—˜ë¼ìŠ¤í‹± ì„œì¹˜ timeout ì—ëŸ¬

ì‹­ë§Œ ê±´ ì´ìƒì˜ ë°ì´í„°ë¥¼ ë„£ì—ˆì„ ë•Œì˜ ìƒí™©ì„ ê°€ì •í•˜ê³ ì ê³µê³µ ë°ì´í„° í¬í„¸ì˜ ê³µì—° ë°ì´í„°ë¥¼ ë„£ì–´ì£¼ì—ˆìŠµë‹ˆë‹¤.

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/a557051f-c7ef-49b4-83dc-fbd1373d5693/58d3b495-1092-4f1f-958c-77ca0c472548/Untitled.png)

ì´ ë•Œ ë°ì´í„°ë¥¼ ë¹ ë¥´ê²Œ ë„£ì–´ì£¼ê¸° ìœ„í•´ bulk insertë¥¼ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.

ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì—˜ë¼ìŠ¤í‹± ì„œì¹˜ë¡œ ìš”ì²­ì„ ë³´ë‚´ëŠ”ë°, ê·¸ íŠ¹ì„± ìƒ í•œë²ˆì˜ ìš”ì²­ì— ëª‡ ë°±ê±´ì˜ ë°ì´í„°(ë„íë¨¼íŠ¸)ë¥¼ ì—˜ë¼ìŠ¤í‹± ì„œì¹˜ì— ì €ì¥í•˜ê²Œ ë©ë‹ˆë‹¤.

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/a557051f-c7ef-49b4-83dc-fbd1373d5693/fe89694c-19eb-439b-b925-3ac5b7b6c9f7/Untitled.png)

```java
org.springframework.dao.DataAccessResourceFailureException: 5,000 milliseconds timeout on connection http-outgoing-0 [ACTIVE];
```

ê·¸ëŸ°ë° ì¼ì • ì‹œê°„ ì•ˆì— ì‘ë‹µì„ ë°›ì§€ ëª»í•˜ë©´ timeout ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.

ì²˜ìŒì—” ì—˜ë¼ìŠ¤í‹± ì„œì¹˜ì˜ ì„¤ì •ì´ ì˜ëª»ë˜ì—ˆë‹¤ê³  íŒë‹¨í–ˆìœ¼ë‚˜, ê²°ê³¼ì ìœ¼ë¡œ Spring Data Elasticsearch Config íŒŒì¼ì—ì„œÂ **ì»¤ë„¥ì…˜ ìœ ì§€ì‹œê°„ì„ ì¡°ì •**í•˜ì—¬ í•´ê²°í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/a557051f-c7ef-49b4-83dc-fbd1373d5693/57ff2d7a-d30b-4f1a-b98f-06d2e8fb3a47/Untitled.png)

- config íŒŒì¼

```java
@Configuration
public class ElasticSearchConfig extends ElasticsearchConfiguration {

	@Override
	public ClientConfiguration clientConfiguration() {
		return ClientConfiguration.builder()
			.connectedTo("localhost:9200")
			.withConnectTimeout(120000) // ì»¤ë„¥ì…˜ ìœ ì§€ ì‹œê°„
			.withSocketTimeout(120000)
			.build();
	}
}
```

## ì„±ëŠ¥ ë¹„êµ

## ë§ˆì¹˜ë©°

ë„ì»¤ë¥¼ í†µí•´ ELK ìŠ¤íƒì„ êµ¬ì„±í•˜ê±°ë‚˜, Spring Data ElasticSearchë¡œ ì¿¼ë¦¬ ì½”ë“œë¥¼ ì‘ì„±í• ë•Œ

ë²„ì „ ë§ˆë‹¤ ì‚¬ìš©ë²•ì´ ìƒì´í•˜ê³ , ê´€ë ¨ ìë£Œê°€ ë§ì´ ì—†ì–´ ì–´ë ¤ì› ë˜ ê²ƒ ê°™ìŠµë‹ˆë‹¤.

ê·¸ëŸ¼ì—ë„ ì—˜ë¼ìŠ¤í‹± ì„œì¹˜ë¥¼ ë„ì…í•´ ê¸°ëŠ¥ì , ì„±ëŠ¥ì ìœ¼ë¡œ ë³´ë‹¤ ê°œì„ í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

ì €í¬ í”„ë¡œì íŠ¸ë‚˜ ì—˜ë¼ìŠ¤í‹± ì„œì¹˜ì— ëŒ€í•´ ê´€ì‹¬ì´ ìˆìœ¼ì‹œë©´ ì‘ì„±í•œ ì•„í‹°í´ê³¼ ê¹ƒí—ˆë¸Œë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.

- ê¹ƒí—ˆë¸ŒÂ [https://github.com/Team-BingBong/BE-05-Bingterpark](https://github.com/Team-BingBong/BE-05-Bingterpark)
- ì•„í‹°í´Â [ELK ìŠ¤íƒ ì„¤ì •](https://github.com/Team-BingBong/BE-05-Bingterpark/wiki/ELK-%EC%8A%A4%ED%83%9D-%EC%84%A4%EC%A0%95)Â [ì—˜ë¼ìŠ¤í‹± ì„œì¹˜ í‚¤ì›Œë“œ ê²€ìƒ‰](https://github.com/Team-BingBong/BE-05-Bingterpark/wiki/%EC%97%98%EB%9D%BC%EC%8A%A4%ED%8B%B1-%EC%84%9C%EC%B9%98-%ED%82%A4%EC%9B%8C%EB%93%9C-%EA%B2%80%EC%83%89)Â [ë¡œê·¸ë¶„ì„ì„ í†µí•œ ì¸ê¸° ê²€ìƒ‰ì–´ ë¶„ì„](https://github.com/Team-BingBong/BE-05-Bingterpark/wiki/%EB%A1%9C%EA%B7%B8%EC%8A%A4%ED%83%9C%EC%8B%9C%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%98%EC%97%AC-%EB%A1%9C%EA%B7%B8%EB%B6%84%EC%84%9D%EC%9D%84-%ED%86%B5%ED%95%9C-%EC%8B%A4%EC%8B%9C%EA%B0%84-%EC%9D%B8%EA%B8%B0-%EA%B2%80%EC%83%89%EC%96%B4-%EC%88%9C%EC%9C%84)Â [Elasticsearch Document Bulk Update ê³¼ì •](https://github.com/Team-BingBong/BE-05-Bingterpark/wiki/Elasticsearch-Document-Update-%EA%B3%BC%EC%A0%95)